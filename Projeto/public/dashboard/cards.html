<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../img/Icons/Demon-Slayer-Logo (1).ico">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demon Slayer | Dashboards</title>
    
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">


    <style>
        .janela {
            background-color: aqua !important;
        }

        .geral {
            background-color: blueviolet;
        }

        .teste {
            display: flex;
            gap: 50px;
        }

        .dash {
            display: flex;
            align-items: center;
            flex-direction: column;
            justify-content: space-evenly;
        }

        .area-kpis {
            display: flex;
            gap: 190px;
        }

        .kpi {
            width: 215px;
            height: 200px;
            border-radius: 25px;
            border: solid red 4px;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            /* font-size: 35px;
            font-weight: 700; */
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 3px 50px rgba(255, 255, 255, 0.7);
        }
        .kpi p{
            font-size: 22px;
            font-weight: 300;
        }
        .kpi span{
            font-size: 35px;
            font-weight: 700;
        }

        .grafico {
            width: 750px;
            background-color: rgb(41, 41, 41);
            border: 2px solid black;
            border-radius: 25px;
            gap: 50px;
            box-shadow: 0 0px 15px rgba(59, 59, 59, 0.7);
        }
    </style>
</head>

<body onload="grafico(), validarUsuario()">

    <div class="janela">

        <div class="header-left dash-header">
            <img src="/img/SemFundo/Demon-Slayer-Logo.png" style="width: 380px;">
            <h1 class="title">Demon Slayer - Project</h1>

            <div class="hello">
                <h3>Olá, bem vindo <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="btn-nav-white">
                <h3>
                    <a href="../quiz.html">
                        Refazer Quiz?
                    </a>
                </h3>
            </div>

            <div class="btn-nav">
                
                    <h3>Dashboard</h3>
                
            </div>

            <div class="btn-nav-white">
                <h3>
                    <a href="./mural.html">
                        Forum
                    </a>
                </h3>
            </div>

           

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>



        <div class="dash">
            <div id="alerta">
            </div>
            <div class="area-kpis">

                <div class="kpi">
                    <p>Média Pontos</p>
                    <span id="kpi1">7</span>
                </div>

                <div class="kpi">
                    <p>Vezes que foi jogado</p>
                    <span id="kpi2">15</span>
                </div>

                <div class="kpi">
                    <p>Melhor Jogador</p>
                    <span id="kpi3">Bryan</span>
                </div>

                <div class="kpi">
                    <p>Sua Colocação</p>
                    <span id="kpi4">1</span>
                </div>

            </div>

            <div class="teste" id="Graficos">
                <div id="Grafico1" class="grafico ">
                    <canvas id="pontuacaoChart" class="chart" width="440px"></canvas>
                </div>
                <div id="Grafico2" class="grafico">
                    <canvas id="pontuacaoChart1" class="chart"></canvas>
                </div>
            </div>
        </div>



    </div>

</body>

<script>

    let ListaUsuarios = [];
    let ListaPontuacao = [];


    function validarUsuario(){  
        var Usuario = sessionStorage.NOME_USUARIO
        
        b_usuario.innerHTML = Usuario;

    }

    function grafico() {

        // fetch('/pontuacao/listar', { method: 'POST' })
        //     .then(response => response.json())
        //     .then(pontuacoes => {
        //         // ... (código do gráfico como mostrado acima) 
        //     })
        //     .catch(error => console.error('Erro ao buscar pontuações:', error));


        fetch('/pontuacao/listar', { method: 'POST' })
            .then(resultado => resultado.json())
            .then(pontuacoes => {

                const labels = []; // Array para armazenar os rótulos do eixo X (Usuários)
                const data = [];   // Array para armazenar os dados do eixo Y (Pontuações)
                const arrayDupla = [];

                pontuacoes.forEach(pontuacao => {

                    labels.push(pontuacao.nome);
                
         
                    data.push(pontuacao.pontuacao);
  


                    arrayDupla.push({
                        NAME: pontuacao.nome, POINTS: pontuacao.pontuacao
                    },);
                });
                // console.log(arrayDupla);
                // Limita os dados para os últimos 7 valores
                const ultimosLabels = labels.slice(-7);
                const ultimosDados = data.slice(-7);

                // Obtendo o contexto do canvas
                const ctx = document.getElementById('pontuacaoChart').getContext('2d');

                // Criando o gráfico de barras (você pode escolher outro tipo)
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ultimosLabels,
                        datasets: [{
                            label: 'Ultimas Pontuações',
                            data: ultimosDados,
                            backgroundColor: 'rgba(255, 0, 0, 0.2)',
                            borderColor: 'rgba(255, 0, 0, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        Plugins:{
                            title:{
                                display: true,
                                text: 'Ultimas Pontuações',
                                position: 'top',
                                padding: {
                                    top: 10,
                                    bottom: 30
                                }

                            }
                        },
                        responsive: true,
                        // Opções de personalização do gráfico (título, eixos, etc.)
                        scales: {
                            y: {
                                beginAtZero: true
                            },
                        
                        }
                    }
                });


                // Ordena a array em ordem decrescente
                arrayDupla.sort((a, b) => b.POINTS - a.POINTS);

                // Pega os primeiros 7 valores da array ordenada
                const Nomes = arrayDupla.map(item => item.NAME);


                const top7 = arrayDupla.slice(0, 7);
                
                const top7Names = top7.map(item => item.NAME);
                const top7Points = top7.map(item => Number(item.POINTS));
                
                const topNome = []
                const topValor = []
                
                for (let i = 0; i < top7Names.length; i++) {
                    topNome.push(top7Names[i]);
                    topValor.push(top7Points[i]);
                }
                let posicao = (Nomes.indexOf(sessionStorage.NOME_USUARIO)+1)
                
                console.log(Nomes);

                console.log(topValor);

                let soma = 0
                for(let i = 0; i <data.length; i++){
                    soma += data[i];
                }

                let media = soma/data.length

                kpi1.innerHTML = `${media.toFixed(2)}`
                kpi2.innerHTML = `${data.length}`
                kpi3.innerHTML = `${topNome[0]}`
                kpi4.innerHTML = `${posicao}°`


                const ctx1 = document.getElementById('pontuacaoChart1').getContext('2d');

                new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: topNome,
                        datasets: [{
                            label: 'Melhores Pontuações',
                            data: topValor,
                            backgroundColor: 'rgba(0, 0, 255, 0.2)',
                            borderColor: 'rgba(0, 0, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
  
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Erro ao buscar pontuações:', error));


            
    }



</script>

</html>